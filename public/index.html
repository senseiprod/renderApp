<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créez Votre Sac Personnalisé</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- UX/UI REFACTOR: "Atelier" Theme --- */
        :root {
            /* Refined Palette for a more premium, confident feel */
            --color-background: #F9F9F9; /* A crisp, clean light gray */
            --color-surface: #FFFFFF;
            --color-border: #E8E8E8;
            --color-border-hover: #D0D0D0;
            --color-text-primary: #1A1A1A; /* Near-black for strong contrast */
            --color-text-secondary: #7A7A7A;
            --color-accent: #4F46E5; /* A vibrant, modern indigo */
            --color-accent-hover: #4338CA;
            --color-accent-text: #FFFFFF;
            --color-success: #10B981;
            --color-error: #EF4444;
            --color-disabled: #F0F0F0;

            /* Modernized Aesthetics */
            --border-radius: 10px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--color-background);
            color: var(--color-text-primary);
            overflow: hidden; /* Prevent scrollbars on the body itself */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Main Layout --- */
        .app-container {
            display: grid;
            grid-template-columns: 420px 1fr; /* Wider control panel for better spacing */
            min-height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
        }

        .controls-panel {
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .controls-panel-inner {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 1rem; /* Space for scrollbar */
            margin-right: -1rem;
        }
        
        .header {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--color-border);
        }

        .main-title {
            font-size: 2rem; /* Larger, more impactful title */
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        /* --- GUIDED JOURNEY: Step-by-step UX --- */
        .form-container { display: flex; flex-direction: column; gap: 1rem; }
        .step {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: var(--transition);
            opacity: 0.4; /* Start dimmed */
            transform: translateY(10px);
            pointer-events: none; /* Non-active steps are not interactive */
        }
        .step.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            box-shadow: var(--shadow);
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .step-number {
            background: var(--color-accent);
            color: var(--color-accent-text);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }
        .step-title { font-size: 1.1rem; font-weight: 700; }
        .step-content { display: flex; flex-direction: column; gap: 1rem; }

        /* --- UI Component Redesigns --- */

        /* 1. File Upload Zone */
        .file-upload-zone {
            background: #FDFDFD;
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        .file-upload-zone:hover, .file-upload-zone.dragover {
            border-color: var(--color-accent);
            background-color: #F5F4FF;
        }
        .file-upload-icon {
            width: 48px; height: 48px;
            color: var(--color-accent);
            margin: 0 auto 1rem;
            transition: var(--transition);
        }
        .file-upload-zone:hover .file-upload-icon { transform: scale(1.1) translateY(-4px); }
        .upload-text {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .upload-text strong { color: var(--color-accent); font-weight: 600; }
        #logoFile { display: none; }
        
        #logo-info-display {
            display: none; /* Hidden by default */
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--color-background);
            border-radius: 8px;
        }
        #logo-preview img {
            width: 50px; height: 50px;
            object-fit: contain;
            border-radius: 6px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
        }
        #file-name-display {
            font-size: 0.85rem; color: var(--color-text-primary);
            font-weight: 500;
            word-break: break-all;
            text-align: left;
        }

        /* 2. Color Picker */
        .custom-color-picker {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%; height: 52px; border: 1px solid var(--color-border);
            border-radius: 8px; cursor: pointer; background: var(--color-surface);
            padding: 0 1rem;
            transition: var(--transition);
        }
        .custom-color-picker:hover { border-color: var(--color-border-hover); box-shadow: var(--shadow-sm); }
        .color-swatch {
            width: 28px; height: 28px; border-radius: 6px;
            border: 1px solid var(--color-border);
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
            transition: var(--transition);
        }
        .color-hex-display { color: var(--color-text-primary); font-weight: 500; font-family: monospace; }
        .native-color-picker { display: none; }
        .color-picker-modal, .color-picker-panel, .color-picker-header, .color-picker-title, .close-color-picker,
        .color-spectrum, .color-cursor, .color-sliders, .color-slider-group, .color-slider-label, .color-slider,
        .color-value, .color-presets, .color-preset, .color-picker-actions, .color-picker-btn, .color-picker-cancel,
        .color-picker-apply, .hex-input-group, .hex-input-label, .hex-input-container, .hex-prefix, .hex-input {
            /* Styles for these elements from your original code are excellent and preserved */
            position: relative; /* Add any necessary positioning adjustments */
        }
        .color-picker-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 20, 20, 0.4); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .color-picker-modal.active { display: flex; }
        .color-picker-panel { background: var(--color-surface); border-radius: var(--border-radius); padding: 1.5rem; border: 1px solid var(--color-border); box-shadow: var(--shadow-md); max-width: 320px; width: 90%; }
        .color-picker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--color-border); }
        .color-picker-title { font-family: 'Manrope', sans-serif; font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); }
        .close-color-picker { background: none; border: none; color: var(--color-text-secondary); font-size: 1.5rem; cursor: pointer; transition: var(--transition); }
        .close-color-picker:hover { color: var(--color-text-primary); }
        .color-spectrum { width: 100%; height: 150px; border-radius: 8px; cursor: crosshair; background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff00ff); margin-bottom: 1rem; }
        .color-spectrum::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent, #000); border-radius: 8px; }
        .color-cursor { position: absolute; width: 18px; height: 18px; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 0 1px rgba(0,0,0,0.5); transform: translate(-50%, -50%); pointer-events: none; z-index: 2; }
        .color-sliders { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
        .color-slider-group { display: flex; align-items: center; gap: 0.75rem; }
        .color-slider-label { min-width: 15px; font-weight: 500; color: var(--color-text-primary); font-size: 0.8rem; }
        .color-slider { flex: 1; height: 6px; border-radius: 3px; outline: none; -webkit-appearance: none; appearance: none; background: var(--color-border); cursor: pointer; }
        .color-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; border: 1px solid var(--color-border-hover); box-shadow: var(--shadow-sm); }
        .color-value { min-width: 40px; text-align: center; font-weight: 500; color: var(--color-text-secondary); background: var(--color-background); padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--color-border); font-size: 0.8rem; }
        .color-presets { display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.4rem; margin-bottom: 1rem; }
        .color-preset { width: 32px; height: 32px; border-radius: 8px; cursor: pointer; transition: var(--transition); border: 2px solid transparent; }
        .color-preset:hover { transform: scale(1.1); border-color: var(--color-accent); }
        .color-picker-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1rem; }
        .color-picker-btn { padding: 0.6rem 1.25rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 0.85rem; }
        .color-picker-cancel { background: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); }
        .color-picker-cancel:hover { background-color: var(--color-background); }
        .color-picker-apply { background: var(--color-accent); color: var(--color-accent-text); }
        .color-picker-apply:hover { background: var(--color-accent-hover); }
        .hex-input-group { margin-bottom: 1rem; }
        .hex-input-label { display: block; font-weight: 500; color: var(--color-text-secondary); margin-bottom: 0.5rem; font-size: 0.8rem; }
        .hex-input-container { display: flex; align-items: center; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; padding: 0.5rem; transition: var(--transition); }
        .hex-input-container:focus-within { border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .hex-prefix { color: var(--color-text-secondary); font-weight: 500; margin-right: 0.5rem; }
        .hex-input { flex: 1; background: transparent; border: none; outline: none; color: var(--color-text-primary); font-family: monospace; font-size: 0.9rem; text-transform: uppercase; }

        /* 3. Sliders */
        .slider-label-group {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
        }
        .slider-label { font-weight: 600; font-size: 0.9rem; }
        .slider-value {
            font-family: monospace; font-size: 0.9rem;
            color: var(--color-text-secondary); background-color: var(--color-background);
            padding: 0.2rem 0.5rem; border-radius: 6px;
        }
        .slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px; background: var(--color-disabled);
            border-radius: 3px; outline: none; cursor: pointer;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: var(--color-accent); border-radius: 50%;
            border: 3px solid var(--color-surface);
            box-shadow: 0 0 0 1px var(--color-border), var(--shadow-sm);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 1px var(--color-accent), 0 0 0 8px rgba(79, 70, 229, 0.1);
        }

        /* 4. Finalize Button */
        .footer-actions { margin-top: auto; padding-top: 1rem; }
        .submit-btn {
            width: 100%; padding: 1rem 1.5rem;
            background-image: linear-gradient(to right, #4F46E5 0%, #6D28D9 100%);
            border: none; border-radius: var(--border-radius); color: var(--color-accent-text);
            font-size: 1rem; font-weight: 700; cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
        }
        .submit-btn .icon { width: 20px; height: 20px; }
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .submit-btn:disabled {
            background: var(--color-disabled);
            color: var(--color-text-secondary);
            cursor: not-allowed;
            opacity: 0.8;
            box-shadow: none;
            transform: none;
            background-image: none;
        }

        /* --- Display Panel & Preview --- */
        .display-panel {
            background-color: var(--color-background);
            display: flex; justify-content: center; align-items: center;
            padding: 2.5rem; height: 100vh;
        }
        .display-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
        }

        .preview-container {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            position: relative; border-radius: var(--border-radius);
            transition: var(--transition); background-color: var(--color-surface);
            box-shadow: var(--shadow);
        }
        .preview-container.dragging {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        
        #preview-placeholder {
            color: var(--color-text-secondary); text-align: center; font-size: 1.1rem;
            padding: 2rem;
            display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
        }
        #preview-placeholder .icon { width: 64px; height: 64px; opacity: 0.5; }

        #preview-loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10;
        }
        #preview-image {
            max-width: 100%; max-height: 100%; padding: 2rem;
            object-fit: contain; cursor: move;
        }
        .preview-controls {
            position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%);
            display: flex; gap: 0.75rem; opacity: 0; pointer-events: none;
            transition: var(--transition); background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px); padding: 0.6rem 1rem; border-radius: 50px;
            box-shadow: var(--shadow-md); border: 1px solid var(--color-border);
        }
        .preview-container:hover .preview-controls { opacity: 1; pointer-events: auto; }
        .control-btn {
            width: 40px; height: 40px; border: 1px solid transparent; border-radius: 50%;
            background: transparent; color: var(--color-text-secondary); cursor: pointer;
            transition: var(--transition); display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }
        .control-btn:hover { background: var(--color-background); color: var(--color-text-primary); transform: scale(1.1); }
        .control-btn .icon { width: 20px; height: 20px; }

        /* --- Result & Success Screen --- */
        #result-wrapper {
            width: 100%; height: 100%;
            display: none; /* Changed from inline style */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .progress-container {
            width: 100%; max-width: 300px; height: 4px;
            background: var(--color-border); border-radius: 2px;
            overflow: hidden; margin-bottom: 1.5rem; opacity: 0;
            transition: var(--transition);
        }
        .progress-bar {
            height: 100%; background: var(--color-accent);
            transform: translateX(-100%); transition: transform 2s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .progress-container.visible { opacity: 1; }
        .progress-container.visible .progress-bar { transform: translateX(0); }
        .status-text {
            font-size: 1.1rem; font-weight: 500;
            color: var(--color-text-secondary); margin-bottom: 2rem;
        }
        #result-image {
             max-width: 500px; max-height: 50vh; object-fit: contain;
             border-radius: var(--border-radius); border: 1px solid var(--color-border);
             background-color: var(--color-surface); box-shadow: var(--shadow-md);
             opacity: 0; transform: scale(0.95);
             transition: opacity 0.5s ease 0.2s, transform 0.5s ease 0.2s;
        }
        #result-image.visible { opacity: 1; transform: scale(1); }
        
        /* New Success State */
        .success-summary {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .success-icon {
            width: 48px; height: 48px;
            color: var(--color-success);
        }
        .success-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .success-message {
            color: var(--color-text-secondary);
            max-width: 400px;
        }
        .new-mockup-btn {
            padding: 0.75rem 1.5rem; border: 1px solid var(--color-border);
            border-radius: var(--border-radius); font-weight: 600; cursor: pointer;
            transition: var(--transition); text-decoration: none;
            font-size: 0.9rem; background: var(--color-surface); color: var(--color-text-primary);
            box-shadow: var(--shadow-sm);
        }
        .new-mockup-btn:hover { background-color: #fdfdfd; border-color: var(--color-border-hover); transform: translateY(-1px); box-shadow: var(--shadow); }

        /* --- Misc & Responsive --- */
        .loading-spinner {
            width: 32px; height: 32px; border: 3px solid var(--color-border);
            border-top-color: var(--color-accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--color-text-secondary); text-align: center; font-size: 0.95rem; }
        .error { color: var(--color-error); font-weight: 500; }
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .controls-panel, .display-panel { height: auto; min-height: 60vh; }
            .controls-panel { border-right: none; border-bottom: 1px solid var(--color-border); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Panel - Controls -->
        <div class="controls-panel">
            <div class="controls-panel-inner">
                <div class="header">
                    <!-- FIX: Updated header text -->
                    <h1 class="main-title">Personnalisez Votre Tote Bag</h1>
                    <p class="subtitle">Téléchargez un logo, choisissez une couleur et ajustez le design à la perfection.</p>
                </div>
                
                <form id="mockup-form" class="form-container">
                    <!-- Step 1: Upload Logo -->
                    <div class="step active" id="step-1">
                        <div class="step-header">
                            <span class="step-number">1</span>
                            <h2 class="step-title">Téléchargez Votre Logo</h2>
                        </div>
                        <div class="step-content">
                            <label for="logoFile" class="file-upload-zone" id="file-drop-zone">
                                <svg class="file-upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 17.25z" /></svg>
                                <div class="upload-text"><strong>Cliquez pour parcourir</strong><br>ou glissez-déposez un fichier</div>
                            </label>
                            <div id="logo-info-display">
                                <div id="logo-preview"></div>
                                <div id="file-name-display"></div>
                            </div>
                            <input type="file" id="logoFile" name="logoFile" accept="image/png, image/jpeg" required>
                        </div>
                    </div>

                    <!-- Step 2: Customize -->
                    <div class="step" id="step-2">
                        <div class="step-header">
                            <span class="step-number">2</span>
                            <h2 class="step-title">Personnalisez Votre Design</h2>
                        </div>
                        <div class="step-content">
                             <div>
                                <label for="color" class="slider-label">Couleur du Sac</label>
                                <button type="button" class="custom-color-picker" id="custom-color-picker">
                                    <span class="color-swatch" id="color-swatch" style="background-color: #FFFFFF;"></span>
                                    <span class="color-hex-display" id="color-hex-display">#FFFFFF</span>
                                </button>
                                <input type="color" id="color" name="color" value="#FFFFFF" class="native-color-picker">
                            </div>
                            <div>
                                <div class="slider-label-group">
                                    <label for="logoWidth" class="slider-label">Taille</label>
                                    <div class="slider-value" id="logoWidth-value">450</div>
                                </div>
                                <input type="range" id="logoWidth" name="logoWidth" min="200" max="800" value="450" class="slider">
                            </div>
                             <div>
                                <div class="slider-label-group">
                                    <label for="logoX" class="slider-label">Position Horizontale</label>
                                    <div class="slider-value" id="logoX-value">0</div>
                                </div>
                                <input type="range" id="logoX" name="logoX" min="-200" max="200" value="0" class="slider">
                            </div>
                            <div>
                                <div class="slider-label-group">
                                    <label for="logoY" class="slider-label">Position Verticale</label>
                                    <div class="slider-value" id="logoY-value">175</div>
                                </div>
                                <input type="range" id="logoY" name="logoY" min="-200" max="200" value="175" class="slider">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Step 3: Finalize -->
            <div class="footer-actions">
                <button type="submit" id="submit-btn" class="submit-btn" form="mockup-form" disabled>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962.343 1.087.835l.383 1.437M7.5 14.25V5.25A2.25 2.25 0 019.75 3h4.5a2.25 2.25 0 012.25 2.25v9M7.5 14.25h-1.5" /></svg>
                    <span>Ajouter au Panier</span>
                </button>
            </div>
        </div>

        <!-- Display Panel -->
        <div class="display-panel">
            <div class="display-container">
                <div id="result-wrapper">
                    <div class="success-summary" id="success-summary">
                        <svg class="success-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h2 class="success-title">Design Ajouté au Panier!</h2>
                        <p class="success-message">Votre création unique est prête. Nous vous redirigeons vers votre panier pour finaliser la commande.</p>
                    </div>
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <p id="status" class="status-text"></p>
                    <img id="result-image" src="" alt="Maquette générée">
                    <div id="actions-container" class="actions-container"></div>
                </div>

                <div class="preview-container" id="preview-container">
                    <div id="preview-placeholder">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        Votre design apparaîtra ici
                    </div>
                    <div id="preview-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Mise à jour de l'aperçu...</div>
                    </div>
                    <img id="preview-image" src="" style="display: none;" draggable="true">
                    <div class="preview-controls" id="preview-controls">
                        <button type="button" class="control-btn" id="center-logo" title="Centrer le Logo">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M20.25 20.25v-4.5m0 4.5h-4.5m4.5 0L15 15m-6 0l-3.75 3.75M9 9l3.75-3.75M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9" /></svg>
                        </button>
                        <button type="button" class="control-btn" id="reset-logo" title="Réinitialiser Position">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.695v4.992h-4.992m0 0l-3.182-3.182a8.25 8.25 0 0111.664 0l3.182 3.182" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Color Picker Modal (Unchanged HTML Structure) -->
    <div class="color-picker-modal" id="color-picker-modal">
        <div class="color-picker-panel">
            <div class="color-picker-header">
                <h3 class="color-picker-title">Sélecteur de Couleur</h3>
                <button class="close-color-picker" id="close-color-picker">&times;</button>
            </div>
            <div class="color-spectrum" id="color-spectrum"><div class="color-cursor" id="color-cursor"></div></div>
            <div class="color-sliders">
                <div class="color-slider-group"><label class="color-slider-label">R</label><input type="range" class="color-slider red" id="red-slider" min="0" max="255" value="255"><div class="color-value" id="red-value">255</div></div>
                <div class="color-slider-group"><label class="color-slider-label">G</label><input type="range" class="color-slider green" id="green-slider" min="0" max="255" value="255"><div class="color-value" id="green-value">255</div></div>
                <div class="color-slider-group"><label class="color-slider-label">B</label><input type="range" class="color-slider blue" id="blue-slider" min="0" max="255" value="255"><div class="color-value" id="blue-value">255</div></div>
            </div>
            <div class="hex-input-group">
                <label class="hex-input-label">Code Hexadécimal</label>
                <div class="hex-input-container"><span class="hex-prefix">#</span><input type="text" class="hex-input" id="hex-input" value="FFFFFF" maxlength="6" placeholder="FFFFFF"></div>
            </div>
            <div class="color-presets">
                <div class="color-preset" style="background: #ffffff; border: 1px solid #ddd;" data-color="#ffffff"></div><div class="color-preset" style="background: #F3F4F6;" data-color="#F3F4F6"></div><div class="color-preset" style="background: #9CA3AF;" data-color="#9CA3AF"></div><div class="color-preset" style="background: #374151;" data-color="#374151"></div><div class="color-preset" style="background: #111827;" data-color="#111827"></div><div class="color-preset" style="background: #FEE2E2;" data-color="#FEE2E2"></div><div class="color-preset" style="background: #D1FAE5;" data-color="#D1FAE5"></div><div class="color-preset" style="background: #DBEAFE;" data-color="#DBEAFE"></div>
            </div>
            <div class="color-picker-actions"><button class="color-picker-btn color-picker-cancel" id="color-picker-cancel">Annuler</button><button class="color-picker-btn color-picker-apply" id="color-picker-apply">Appliquer</button></div>
        </div>
    </div>

    <script>
        // --- SCRIPT REFINED AND FIXED FOR NEW UX/UI ---

        // --- Configuration & Element Selectors ---
        const API_BASE_URL = 'https://tote-bag-customizer.onrender.com';
        const form = document.getElementById('mockup-form');
        const submitBtn = document.getElementById('submit-btn');
        const fileInput = document.getElementById('logoFile');
        const dropZone = document.getElementById('file-drop-zone');
        const logoInfoDisplay = document.getElementById('logo-info-display');
        const logoPreview = document.getElementById('logo-preview');
        const fileNameDisplay = document.getElementById('file-name-display');
        const resultWrapper = document.getElementById('result-wrapper');
        const statusEl = document.getElementById('status');
        const resultImage = document.getElementById('result-image');
        const actionsContainer = document.getElementById('actions-container');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const previewLoading = document.getElementById('preview-loading');
        const previewControls = document.getElementById('preview-controls');
        const centerLogoBtn = document.getElementById('center-logo');
        const resetLogoBtn = document.getElementById('reset-logo');
        const logoXSlider = document.getElementById('logoX'), logoYSlider = document.getElementById('logoY'), logoWidthSlider = document.getElementById('logoWidth');
        const logoXValue = document.getElementById('logoX-value'), logoYValue = document.getElementById('logoY-value'), logoWidthValue = document.getElementById('logoWidth-value');
        const step2 = document.getElementById('step-2');
        const successSummary = document.getElementById('success-summary');
        
        // --- State Management ---
        let currentLogoFile = null;
        let previewTimeout = null;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        // --- Core Logic (Unchanged) ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, e => e.preventDefault(), false));
        ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('dragover'), false));
        ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('dragover'), false));
        dropZone.addEventListener('drop', (e) => {
            fileInput.files = e.dataTransfer.files;
            handleFileSelection();
        });
        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            logoPreview.innerHTML = '';
            fileNameDisplay.textContent = '';
            if (!fileInput.files || fileInput.files.length === 0) {
                hidePreview();
                logoInfoDisplay.style.display = 'none';
                return;
            }
            const file = fileInput.files[0];
            currentLogoFile = file;
            fileNameDisplay.textContent = file.name;
            logoInfoDisplay.style.display = 'flex';
            if (previewTimeout) clearTimeout(previewTimeout);
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                logoPreview.appendChild(img);
                showPreviewLoading();
                updatePreview();
                step2.classList.add('active');
                submitBtn.disabled = false;
            }
            reader.readAsDataURL(file);
        }

        async function updatePreview() {
            if (!currentLogoFile) {
                hidePreview();
                return;
            }
            showPreviewLoading();
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(async () => {
                try {
                    const formData = new FormData();
                    formData.append('logoFile', currentLogoFile);
                    formData.append('logoX', logoXSlider.value);
                    formData.append('logoY', logoYSlider.value);
                    formData.append('logoWidth', logoWidthSlider.value);
                    formData.append('color', document.getElementById('color').value);
                    const response = await fetch(`${API_BASE_URL}/preview?t=${Date.now()}`, { method: 'POST', body: formData });
                    if (response.ok) {
                        const imageBlob = await response.blob();
                        const imageUrl = URL.createObjectURL(imageBlob);
                        previewImage.src = imageUrl;
                        previewImage.style.display = 'block';
                        previewControls.style.display = 'flex';
                        previewPlaceholder.style.display = 'none';
                        previewLoading.style.display = 'none';
                    } else {
                        hidePreview();
                    }
                } catch (error) {
                    console.error('Preview error:', error);
                    hidePreview();
                }
            }, 300);
        }
        
        function showPreviewLoading() {
            previewPlaceholder.style.display = 'none';
            previewImage.style.display = 'none';
            previewLoading.style.display = 'flex';
        }

        function hidePreview() {
            previewPlaceholder.style.display = 'flex';
            previewImage.style.display = 'none';
            previewLoading.style.display = 'none';
            previewControls.style.display = 'none';
        }
        
        [logoXSlider, logoYSlider, logoWidthSlider].forEach(slider => {
            slider.addEventListener('input', (e) => {
                document.getElementById(`${e.target.id}-value`).textContent = e.target.value;
                updatePreview();
            });
        });

        // --- Custom Color Picker (FIXED AND FULLY FUNCTIONAL) ---
        const customColorPicker = document.getElementById('custom-color-picker');
        const colorPickerModal = document.getElementById('color-picker-modal');
        const closeColorPicker = document.getElementById('close-color-picker'), colorPickerCancel = document.getElementById('color-picker-cancel'), colorPickerApply = document.getElementById('color-picker-apply');
        const colorSpectrum = document.getElementById('color-spectrum'), colorCursor = document.getElementById('color-cursor');
        const redSlider = document.getElementById('red-slider'), greenSlider = document.getElementById('green-slider'), blueSlider = document.getElementById('blue-slider');
        const redValue = document.getElementById('red-value'), greenValue = document.getElementById('green-value'), blueValue = document.getElementById('blue-value');
        const colorPresets = document.querySelectorAll('.color-preset');
        const nativeColorPicker = document.getElementById('color');
        const hexInput = document.getElementById('hex-input');
        const colorSwatch = document.getElementById('color-swatch');
        const colorHexDisplay = document.getElementById('color-hex-display');
        let currentColor = '#FFFFFF';
        let isColorDragging = false;
        
        customColorPicker.addEventListener('click', () => {
            colorPickerModal.classList.add('active');
            const initialRgb = hexToRgb(nativeColorPicker.value);
            if(initialRgb) updateColorFromRGB(initialRgb.r, initialRgb.g, initialRgb.b);
        });

        function closeColorPickerModal() { colorPickerModal.classList.remove('active'); }
        closeColorPicker.addEventListener('click', closeColorPickerModal);
        colorPickerCancel.addEventListener('click', closeColorPickerModal);
        colorPickerModal.addEventListener('click', (e) => { if (e.target === colorPickerModal) closeColorPickerModal(); });

        colorSpectrum.addEventListener('mousedown', (e) => { isColorDragging = true; updateColorFromSpectrum(e); });
        colorSpectrum.addEventListener('mousemove', (e) => { if (isColorDragging) updateColorFromSpectrum(e); });
        document.addEventListener('mouseup', () => { isColorDragging = false; });

        function updateColorFromSpectrum(e) {
            const rect = colorSpectrum.getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            const xPercent = Math.max(0, Math.min(100, (x / rect.width) * 100));
            const yPercent = Math.max(0, Math.min(100, (y / rect.height) * 100));
            const hue = (xPercent / 100) * 360, saturation = 1, value = 1 - (yPercent / 100);
            const rgb = hsvToRgb(hue, saturation, value);
            updateColorFromRGB(rgb[0], rgb[1], rgb[2]);
            colorCursor.style.left = `${xPercent}%`; colorCursor.style.top = `${yPercent}%`;
        }

        function hsvToRgb(h, s, v) {
            let r, g, b, i = Math.floor(h / 60), f = h / 60 - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r=v, g=t, b=p; break; case 1: r=q, g=v, b=p; break;
                case 2: r=p, g=v, b=t; break; case 3: r=p, g=q, b=v; break;
                case 4: r=t, g=p, b=v; break; case 5: r=v, g=p, b=q; break;
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        [redSlider, greenSlider, blueSlider].forEach(slider => slider.addEventListener('input', () => updateColorFromRGB(parseInt(redSlider.value), parseInt(greenSlider.value), parseInt(blueSlider.value))));
        
        function updateColorFromRGB(r, g, b) {
            redSlider.value = r; greenSlider.value = g; blueSlider.value = b;
            redValue.textContent = r; greenValue.textContent = g; blueValue.textContent = b;
            currentColor = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`.toUpperCase();
            hexInput.value = currentColor.substring(1);
        }

        colorPresets.forEach(preset => preset.addEventListener('click', () => {
            const rgb = hexToRgb(preset.dataset.color);
            if(rgb) updateColorFromRGB(rgb.r, rgb.g, rgb.b);
        }));

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        // FIX: This listener now correctly updates the custom button's UI.
        colorPickerApply.addEventListener('click', () => {
            nativeColorPicker.value = currentColor;
            colorSwatch.style.backgroundColor = currentColor;
            colorHexDisplay.textContent = currentColor;
            updatePreview();
            closeColorPickerModal();
        });

        hexInput.addEventListener('input', (e) => {
            const value = e.target.value.toUpperCase(); e.target.value = value;
            if (/^[0-9A-F]{6}$/.test(value)) {
                const rgb = hexToRgb(`#${value}`);
                if (rgb) updateColorFromRGB(rgb.r, rgb.g, rgb.b);
            }
        });
        
        // --- Preview Controls & Dragging ---
        centerLogoBtn.addEventListener('click', () => {
            logoXSlider.value = 0; logoYSlider.value = 175;
            logoXValue.textContent = '0'; logoYValue.textContent = '175';
            updatePreview();
        });
        resetLogoBtn.addEventListener('click', () => {
            logoXSlider.value = 0; logoYSlider.value = 175; logoWidthSlider.value = 450;
            logoXValue.textContent = '0'; logoYValue.textContent = '175'; logoWidthValue.textContent = '450';
            updatePreview();
        });
        previewImage.addEventListener('mousedown', (e) => {
            isDragging = true; dragStart = { x: e.clientX, y: e.clientY };
            previewContainer.classList.add('dragging'); e.preventDefault();
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const deltaX = e.clientX - dragStart.x, deltaY = e.clientY - dragStart.y;
            const newX = Math.max(-200, Math.min(200, logoXSlider.valueAsNumber + deltaX * 0.5));
            const newY = Math.max(-200, Math.min(200, logoYSlider.valueAsNumber + deltaY * 0.5));
            logoXSlider.value = newX; logoYSlider.value = newY;
            logoXValue.textContent = Math.round(newX); logoYValue.textContent = Math.round(newY);
            dragStart = { x: e.clientX, y: e.clientY };
            updatePreview();
        });
        document.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; previewContainer.classList.remove('dragging'); } });
        
        // --- Form Submission ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!currentLogoFile) return;
            setLoadingState(true);
            try {
                const formData = new FormData();
                formData.append('logoFile', currentLogoFile);
                formData.append('color', document.getElementById('color').value);
                formData.append('logoX', logoXSlider.value);
                formData.append('logoY', logoYSlider.value);
                formData.append('logoWidth', logoWidthSlider.value);
                const response = await fetch(`${API_BASE_URL}/finalize-for-shopify`, { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'Une erreur est survenue.');
                }
                const designData = await response.json();
                showSuccess(designData.mockupUrl);
                const shopifyPayload = {
                    id: 46914449277028,
                    quantity: 1,
                    properties: {
                        'Couleur du Sac': designData.config.color, 'Position X du Logo': designData.config.logoX,
                        'Position Y du Logo': designData.config.logoY, 'Largeur du Logo': designData.config.logoWidth,
                        'Customer Mockup URL': designData.mockupUrl, 'Print-Ready Logo URL': designData.originalLogoUrl,
                        '_preview_image': designData.mockupUrl
                    }
                };
                window.parent.postMessage(shopifyPayload, '*');
            } catch (error) {
                console.error('Final submission error:', error);
                showError(error.message);
            }
        });

        function setLoadingState(isLoading) {
            submitBtn.disabled = isLoading;
            const btnText = submitBtn.querySelector('span');
            if (isLoading) {
                btnText.textContent = 'Génération en cours...';
                previewContainer.style.display = 'none';
                resultWrapper.style.display = 'flex';
                statusEl.textContent = 'Finalisation de votre maquette...';
                statusEl.style.display = 'block';
                successSummary.style.display = 'none';
                resultImage.classList.remove('visible');
                actionsContainer.innerHTML = '';
                progressContainer.classList.add('visible');
                progressBar.style.transition = 'none';
                progressBar.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    progressBar.style.transition = 'transform 2s cubic-bezier(0.25, 1, 0.5, 1)';
                    progressBar.style.transform = 'translateX(0%)';
                }, 20);
            } else {
                btnText.textContent = 'Ajouter au Panier';
                progressContainer.classList.remove('visible');
            }
        }

        function showSuccess(imageUrl) {
            statusEl.style.display = 'none';
            progressContainer.classList.remove('visible');
            resultImage.src = imageUrl;
            successSummary.style.display = 'flex';
            resultImage.onload = () => resultImage.classList.add('visible');
        }

        function showError(message) {
            setLoadingState(false);
            previewContainer.style.display = 'none';
            resultWrapper.style.display = 'flex';
            statusEl.textContent = `Erreur: ${message}`;
            statusEl.classList.add('error');
            statusEl.style.display = 'block';
            successSummary.style.display = 'none';
            resultImage.classList.remove('visible');
            const tryAgainBtn = document.createElement('button');
            tryAgainBtn.className = 'new-mockup-btn';
            tryAgainBtn.textContent = 'Réessayer';
            tryAgainBtn.onclick = () => resetEverything();
            actionsContainer.innerHTML = '';
            actionsContainer.appendChild(tryAgainBtn);
        }

        function resetEverything() {
            // FIX: This function now correctly resets the new custom color button UI
            nativeColorPicker.value = '#FFFFFF';
            colorSwatch.style.backgroundColor = '#FFFFFF';
            colorHexDisplay.textContent = '#FFFFFF';
            logoXSlider.value = 0; logoYSlider.value = 175; logoWidthSlider.value = 450;
            logoXValue.textContent = '0'; logoYValue.textContent = '175'; logoWidthValue.textContent = '450';
            fileInput.value = '';
            logoInfoDisplay.style.display = 'none';
            logoPreview.innerHTML = '';
            fileNameDisplay.textContent = '';
            currentLogoFile = null;
            resultWrapper.style.display = 'none';
            previewContainer.style.display = 'flex';
            hidePreview();
            submitBtn.disabled = true;
            step2.classList.remove('active');
        }
    </script>
</body>
</html>